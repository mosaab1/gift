<!DOCTYPE html>
<html lang="en">
<head>
    <title>Convert to Moodle GIFT Format</title>

    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/js/all.min.js" crossorigin="anonymous"></script>

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f8ff;
        }

        h2 {
            color: #003366;
            font-weight: 700;
        }

        .explanation-text {
            font-size: 0.85em;
            color: #6c757d;
        }

        .card {
            border-radius: 10px;
            background: #ffffff;
            box-shadow: 0px 3px 6px rgba(0, 0, 0, 0.1);
        }

        .btn-custom {
            background-color: #007bff;
            color: white;
            font-weight: 600;
            padding: 10px 20px;
            border-radius: 8px;
            transition: 0.3s;
        }

        .btn-custom:hover {
            background-color: #0056b3;
        }

        .icon {
            margin-right: 8px;
        }

        .info-box {
            background: #e3f2fd;
            padding: 15px;
            border-left: 5px solid #007bff;
            border-radius: 8px;
        }

        .info-box pre {
            background: #ffffff;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #d1d1d1;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h2><i class="fas fa-file-alt"></i> Convert to Moodle GIFT Format</h2>

        <div class="row mb-3">
            <label class="col-auto col-form-label"><i class="fas fa-folder"></i> Category:</label>
            <div class="col">
                <div class="row">
                    <div class="col-sm-3 mb-2">
                        <input type="text" class="form-control form-control-sm category-input">
                        <div class="explanation-text">Example: Vocabulary 6</div>
                    </div>
                    <div class="col-sm-3 mb-2">
                        <input type="text" class="form-control form-control-sm category-input">
                        <div class="explanation-text">Example: Feeling Good</div>
                    </div>
                    <div class="col-sm-3 mb-2">
                        <input type="text" class="form-control form-control-sm category-input">
                        <div class="explanation-text">Example: Body&Health</div>
                    </div>
                    <div class="col-sm-3 mb-2">
                        <input type="text" class="form-control form-control-sm category-input">
                        <div class="explanation-text">Example: EX3 Body&Health (MC)</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <label class="col-auto col-form-label"><i class="fas fa-question-circle"></i> Question Name:</label>
            <div class="col-md-3">
                <input type="text" id="questionNameInput" class="form-control form-control-sm">
                <div class="explanation-text">Example: 6th_Voc_EX3</div>
            </div>
            <label class="col-auto col-form-label"><i class="fas fa-file-alt"></i> Question Name Extension:</label>
            <div class="col-md-4">
                <input type="text" id="questionNameExtensionInput" class="form-control form-control-sm">
                <div class="explanation-text">Example: The correct answer is...</div>
            </div>
            <label class="col-auto col-form-label"><i class="fas fa-file-alt"></i> Question Description:</label>
            <div class="col-md-4">
                <input type="text" id="questionDescriptionInput" class="form-control form-control-sm">
                <div class="explanation-text">Example: Choose the right sentence.</div>
            </div>

        </div>

        <div class="row mb-3">
            <label class="col-auto col-form-label"><i class="fas fa-tags"></i> Tags:</label>
            <div class="col">
                <div class="row">
                    <div class="col-sm-2 mb-2">
                        <input type="text" class="form-control form-control-sm tag-input">
                        <div class="explanation-text">Example: 6th</div>
                    </div>
                    <div class="col-sm-2 mb-2">
                        <input type="text" class="form-control form-control-sm tag-input">
                        <div class="explanation-text">Example: definitions</div>
                    </div>
                    <div class="col-sm-2 mb-2">
                        <input type="text" class="form-control form-control-sm tag-input">
                        <div class="explanation-text">Example: 6th_voc_Ex3</div>
                    </div>
                    <div class="col-sm-2 mb-2">
                        <input type="text" class="form-control form-control-sm tag-input">
                        <div class="explanation-text">Example: MC</div>
                    </div>
                    <div class="col-sm-2 mb-2">
                        <input type="text" class="form-control form-control-sm tag-input">
                        <div class="explanation-text">Example: Feeling Good</div>
                    </div>
                    <div class="col-sm-2 mb-2">
                        <input type="text" class="form-control form-control-sm tag-input">
                        <div class="explanation-text">Example: Body & Health</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <div class="row">
                    <div class="col-md-4 mb-2 d-flex align-items-center">
                        <label class="form-label me-2 mb-0">Instructions Class:</label>
                        <input type="text" id="instructionsClassInput" class="form-control form-control-sm" value="q_1st_instructions" style="width: 150px;">
                    </div>
                    <div class="col-md-4 mb-2 d-flex align-items-center">
                        <label class="form-label me-2 mb-0">Question Class:</label>
                        <input type="text" id="questionClassInput" class="form-control form-control-sm" value="q_stem" style="width: 150px;">
                    </div>
                    <div class="col-md-4 mb-2 d-flex align-items-center">
                        <label class="form-label me-2 mb-0">Option Class:</label>
                        <input type="text" id="optionClassInput" class="form-control form-control-sm" value="options" style="width: 150px;">
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-7">
                <label for="richTextInput" class="form-label"><i class="fas fa-edit"></i> <span class="fw-bold fs-5">Enter your questions here:</span></label>
                <textarea id="richTextInput" class="form-control" rows="11"></textarea>
            </div>

            <div class="col-md-5">
                <div class="info-box">
                    <h5><i class="fas fa-info-circle"></i> Formatting Instructions</h5>
                    <p>Use **numeric numbering** for questions and **non-numeric bullets** for answer options.</p>
                    <p>Example format:</p>
                    <pre>
1. You are not sick.
   i. hope
   ii. tired
   iii. well
   iv. remember
                    </pre>
                </div>
            </div>
        </div>

        <button id="proceedButton" class="btn btn-custom"><i class="fas fa-play-circle"></i> Proceed</button>

        <div class="row">
            <div class="col-md-7 mt-4">
                <label for="resultDisplay" class="form-label"><i class="fas fa-file-code"></i> <span class="fw-bold fs-5">Your GIFT format:</span></label>
                <textarea id="resultDisplay" class="form-control" rows="11" readonly></textarea>
            </div>
            <div class="col-md-5 mt-4">
                <i class="fa-solid fa-video"></i> <span class="fw-bold fs-6">Video Tutorials:</span>
                <div class="embed-responsive">
                    <video class="w-100" controls>
                        <source src="https://mosaab1.github.io/gift/gift.mp4" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Clear input fields on page refresh (F5)
            if (performance.navigation.type === 1) {
                document.querySelectorAll("input, textarea").forEach(input => {
                    input.value = "";
                });
            }
    
            // Setup autocomplete and local storage listeners
            setupAutocomplete(".category-input", "categories");
            setupAutocomplete(".tag-input", "tags");
            setupAutocomplete("#questionNameInput", "questionName");
            setupAutocomplete("#questionDescriptionInput", "questionDescription");
            setupAutocomplete("#instructionsClassInput", "instructionsClass");
            setupAutocomplete("#questionClassInput", "questionClass");
            setupAutocomplete("#optionClassInput", "optionClass");
    
            setupLocalStorageListeners();
    
            // Process GIFT format on button click
            document.getElementById('proceedButton').addEventListener('click', function () {
                let questionName = document.getElementById('questionNameInput').value.trim();
                let questionNameExtension = document.getElementById('questionNameExtensionInput').value.trim();
                let questionDescription = document.getElementById('questionDescriptionInput').value.trim();
                const inputText = document.getElementById('richTextInput').value;
                const questions = inputText.split(/\n(?=\d+\.)/);
                const tags = Array.from(document.querySelectorAll('.tag-input')).map(input => input.value.trim()).filter(tag => tag);
                const categories = Array.from(document.querySelectorAll('.category-input')).map(input => input.value.trim()).filter(category => category);
                const instructionsClass = document.getElementById('instructionsClassInput').value.trim();
                const questionClass = document.getElementById('questionClassInput').value.trim();
                const optionClass = document.getElementById('optionClassInput').value.trim();
    
                let giftText = "";
                let questionNumber = 1;
                const now = new Date();
                const dateTimeString = `${String(now.getDate()).padStart(2, '0')}-${String(now.getMonth() + 1).padStart(2, '0')}-${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;

    
                let categoryString = `$CATEGORY: $course$/top/`;
                categoryString += categories.length ? categories.join('/') + ' ' + dateTimeString + '\n\n' : dateTimeString + '\n\n';
                giftText += categoryString;
    
                questions.forEach(question => {
                    const lines = question.split('\n');
                    let questionLine = lines[0].trim().replace(/^\d+\.?\s*/, '');
                    let options = lines.slice(1).map(line => line.trim().replace(/^(?:[^\d\w]\s*|\w+\.\s*)/, '')).filter(line => line);
    
                    // Identify the correct answer (always the first option before shuffling)
                    let correctAnswer = options.length > 0 ? options[0] : "";
    
                    // Shuffle options
                    for (let i = options.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [options[i], options[j]] = [options[j], options[i]];
                    }
    
                    const formattedQuestionNumber = String(questionNumber).padStart(2, '0');
    
                    if (tags.length) {
                        giftText += "// " + tags.map(tag => `[tag:${tag}]`).join(" ") + "\n";
                    }
    
                    giftText += `::${questionName}${questionNameExtension}_Q${formattedQuestionNumber}[${correctAnswer}]::`;
                    if (questionDescription) {
                        giftText += `<p class\\="${instructionsClass}">${questionDescription}</p>`;
                    }
                    giftText += `<p class\\="${questionClass}">${questionLine}</p> {\n`;
    
                    options.forEach(option => {
                        giftText += option === correctAnswer ? `=<p class\\="${optionClass}">${option}</p>\n` : `~<p class\\="${optionClass}">${option}</p>\n`;
                    });
    
                    giftText += "}\n\n";
                    questionNumber++;
                });
    
                document.getElementById('resultDisplay').value = giftText.trim();
    
                // Handle file saving
                if (!questionName) {
                    questionName = prompt("Please enter a file name:", "my_questions");
                    if (!questionName) {
                        alert("File save cancelled.");
                        return;
                    }
                }
    
                const blob = new Blob([giftText.trim()], { type: "text/plain" });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `${questionName} ${dateTimeString}.txt`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    
        // Setup local storage listeners for input fields
        function setupLocalStorageListeners() {
            setupLocalStorageListener(".category-input", "categories");
            setupLocalStorageListener(".tag-input", "tags");
            setupLocalStorageListener("#questionNameInput", "questionName");
            setupLocalStorageListener("#questionDescriptionInput", "questionDescription");
            setupLocalStorageListener("#instructionsClassInput", "instructionsClass");
            setupLocalStorageListener("#questionClassInput", "questionClass");
            setupLocalStorageListener("#optionClassInput", "optionClass");
        }
    
        // Setup local storage listener for a specific input field
        function setupLocalStorageListener(inputSelector, storageKey) {
            document.querySelectorAll(inputSelector).forEach(input => {
                input.addEventListener("blur", function () {
                    let storedValues = JSON.parse(localStorage.getItem(storageKey) || "[]");
                    if (this.value.trim() && !storedValues.includes(this.value.trim())) {
                        storedValues.push(this.value.trim());
                        localStorage.setItem(storageKey, JSON.stringify(storedValues));
                    }
                });
            });
        }
    
        // Setup autocomplete for a specific input field
        function setupAutocomplete(inputSelector, storageKey) {
            const storedValues = JSON.parse(localStorage.getItem(storageKey) || "[]");
            if (storedValues.length === 0) return;
    
            let datalist = document.createElement("datalist");
            datalist.id = `${storageKey}-datalist`;
            datalist.innerHTML = storedValues.map(v => `<option value="${v}">`).join("");
            document.body.appendChild(datalist);
    
            document.querySelectorAll(inputSelector).forEach(input => {
                input.setAttribute("list", datalist.id);
            });
        }
    </script>
</body>
</html>
